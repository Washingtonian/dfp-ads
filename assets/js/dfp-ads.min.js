/**
 * Javascript for Google Ads
 *
 **/

/**
 * Browser sizes [browser size] [ad size]
 * @type {Array}
 */
var browser_sizes = [
    ['0,0', '88,31'],
    ['200,100', '180,90'],
    ['200,180', '180,150'],
    ['220,220', '200,200'],
    ['300,200', '245,155'],
    ['320,50', '300,100'],
    ['320,400', '300,250'],
    ['360,100', '320,50'],
    ['360,400', '336,280'],
    ['320,800', '300,600'],
    ['400,700', '160,600'],
    ['500,200', '468,60'],
    ['500,600', '240,400'],
    ['740,250', '728,90'],
    ['990,250', '970,90'],
    ['990,250', '970,250']
];

googletag.cmd.push(function () {

    // Object from Ajax
    var dfp_ad_data = dfp_ad_object[0],
        acct_id = dfp_ad_data.account_id;

    for (var position in dfp_ad_data['positions']) {
        var target = dfp_ad_data['positions'][position]['position_tag'];
        if (target != null) {
            if (document.getElementById(target) == null) {
                dfp_ad_data['positions'].splice(position, 1);
            }
        }
    }

    /**
     * Loads Ad Position
     *
     * @param {Array} positions - Array of ad positions
     */
    function load_ad_positions(positions) {
        var ad_pos, len;
        // Run through positions
        for (ad_pos = 0, len = positions.length; ad_pos < len; ++ad_pos) {
          console.log("Building slot " + ad_pos + " out of " + len)
            define_ad_slot(positions[ad_pos]);
        }
    }

    /**
     * Loads Ad Position
     *
     * @param {Object} position - Array of ad positions
     */
    function define_ad_slot(position) {

      var map = googletag.sizeMapping();
      var i=0;

      for (var size in position['sizes']) {
          for (var browser in browser_sizes) {
              if ((position['sizes'][size][0] != 'undefined') && (browser_sizes[browser][1] == position['sizes'][size][0] + ',' + position['sizes'][size][1])) {
                  map.addSize(browser_sizes[browser][0].split(',').map(Number), position['sizes'][size]);
                  console.log("adding " + browser_sizes[browser][0].split(',').map(Number) +" and " + position['sizes'][size])
                  i++;
              }
          }
      }
      if (i) {
        map.addSize([0,0],[]);
      }
      var googleAdUnit = googletag.defineSlot(
            acct_id + position.ad_name,
            position.sizes,
            position.position_tag
        );
        if (googleAdUnit) {
          googleAdUnit.defineSizeMapping(map.build()).addService(googletag.pubads());
        }

    }

    /**
     * Sets Page level targeting
     * @param {object} targeting
     */
    function set_targeting(targeting) {
        for (var target in targeting) {
            var key = target.toLowerCase();
            googletag.pubads().setTargeting(key, targeting[target]);
        }
    }

    // Generates Ad Slots
    load_ad_positions(dfp_ad_data.positions);
    // Collapse Empty Divs
    //    googletag.pubads().collapseEmptyDivs(true);
    // Targeting
    set_targeting(dfp_ad_data.page_targeting);
    // Asynchronous Loading
    if (dfp_ad_data.asynch === true) {
        googletag.pubads().enableAsyncRendering();
    }
    // Go
    googletag.enableServices();
});
